package SimpleExample.client;

import java.io.IOException;
import java.net.Socket;
import java.net.UnknownHostException;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.DataLine;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.SourceDataLine;

import SimpleExample.common.Configuration;
import SimpleExample.common.ImageBufferElement;

public class Client {
public static SourceDataLine mLine;
	private static void showMovie(ClientImageBuffer cib, ClientGui gui){
		AudioFormat audioFormat = new AudioFormat(44100, 16, 2, true, false);
		DataLine.Info info = new DataLine.Info(SourceDataLine.class,
				audioFormat);
		ClientAudioBuffer audioBuffer;
		ClientSoundPlayer soundPlayer;
		
		try {
			mLine = (SourceDataLine) AudioSystem
					.getLine(info);
			mLine.open(audioFormat, 1024);
			mLine.start();
			audioBuffer = new ClientAudioBuffer();
			soundPlayer = new ClientSoundPlayer(audioBuffer);
			soundPlayer.start();
		} catch (LineUnavailableException e) {
			throw new RuntimeException("could not open audio line");
		}
		long previousTimestamp = 0;
		long lastShown = 0;
		while (cib.moreToShow()) {
			cib.waitForPlay();
			ImageBufferElement image = cib.getImage();
			long timestamp = image.getTimestamp();
			try {
				long timeToSleep = timestamp-previousTimestamp-(System.currentTimeMillis()-lastShown);
				if (timeToSleep > 0){
					Thread.sleep(timeToSleep);				
				}
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
			previousTimestamp = timestamp;
			gui.setImage(image.getImage());
			gui.updateProgressBar();
			lastShown = System.currentTimeMillis();
		}
	}

	public static void main(String[] args) {

		try {
			Socket socket = new Socket(Configuration.CLIENT_HOST, Configuration.COM_PORT);
			Socket audioSocket = new Socket(Configuration.CLIENT_HOST, Configuration.AUDIO_COM_PORT);
			ClientSender cs = new ClientSender(socket);
			ClientImageBuffer cib = new ClientImageBuffer();
			ClientAudioBuffer cab = new ClientAudioBuffer();
			cs.sendGetMovieList();
			ClientReceiver ir = new ClientReceiver(cib,socket);
			ClientAudioReceiver car = new ClientAudioReceiver(cab, audioSocket);
			ir.start();
			car.start();
			ClientGui gui = new ClientGui(cs,cib,cab);
			gui.setSocket(socket);
			showMovie(cib,gui);
		} catch (UnknownHostException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}

	

}
